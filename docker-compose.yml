# IoT Home Security - Docker Compose
# Usage:
#   docker compose up                    # Start API server
#   docker compose run --rm app test     # Run tests  
#   docker compose run --rm app detect   # Test detection
#   docker compose --profile camera up   # Start with camera
#   docker compose run --rm app bash     # Interactive shell

services:
  app:
    build: .
    image: iot-home-security:latest
    container_name: home-security
    
    volumes:
      - ./src:/app/src:ro
      - ./config:/app/config:ro
      - ./data:/app/data
      - ./logs:/app/logs
    
    ports:
      - "8000:8000"
    
    environment:
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=INFO
    
    # Default: start API server
    command: ["python", "-m", "src.cli", "start"]
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    
    restart: unless-stopped

  # Camera service - only starts with --profile camera
  camera:
    profiles: ["camera"]
    extends: app
    container_name: home-security-camera
    devices:
      - /dev/video0:/dev/video0
    volumes:
      - ./src:/app/src:ro
      - ./config:/app/config:ro
      - ./data:/app/data
      - /tmp/.X11-unix:/tmp/.X11-unix:ro
    environment:
      - PYTHONUNBUFFERED=1
      - DISPLAY=${DISPLAY:-:0}
    network_mode: host
    ports: []
    command: ["python", "-m", "src.cli", "detect", "--camera"]
    restart: "no"
